# AUTOGENERATED! DO NOT EDIT! File to edit: ../../Notebooks/01_datasets/01_02_tid2013.ipynb.

# %% auto 0
__all__ = ['TID2013']

# %% ../../Notebooks/01_datasets/01_02_tid2013.ipynb 3
from pathlib import Path
from typing import List

import pandas as pd
import tensorflow as tf
import cv2

# %% ../../Notebooks/01_datasets/01_02_tid2013.ipynb 5
class TID2013():
    """Builder for the TID2013 dataset"""

    def __init__(self,
                 path, # Path to the root directory of the dataset.
                 exclude_imgs: List[int] = None, #Â Image ID's to exclude.
                 exclude_dist: List[int] = None, # Distortion ID's to exclude.
                 exclude_ints: List[int] = None, # Distortion Intensities ID's to exclude.
                 num_parallel_calls: int = tf.data.AUTOTUNE, # Number of parallel calls when loading the images.
                 ):
        self.path_root = Path(path) if isinstance(path, str) else path
        self.path_ref = self.path_root/"reference_images"
        self.path_dist = self.path_root/"distorted_images"
        self.path_csv = self.path_root/"image_pairs_mos.csv"
        self.data = self.load_data(self.path_csv, exclude_imgs, exclude_dist, exclude_ints)
        self.paths_ref = [str(self.path_ref/p) for p in self.data["Reference"]]
        self.paths_dist = [str(self.path_dist/p) for p in self.data["Distorted"]]
        self.num_parallel_calls = num_parallel_calls

    @property
    def dataset(self):
        """tf.data.Dataset object built from the TID2013 dataset."""
        return tf.data.Dataset.from_tensor_slices((self.paths_ref, self.paths_dist, self.data["MOS"]))\
                              .map(self.preprocess, num_parallel_calls=self.num_parallel_calls)

    @staticmethod
    def preprocess(path_ref,
                   path_dist,
                   mos,
                   ):
        img_ref = tf.io.read_file(path_ref)
        img_dist = tf.io.read_file(path_dist)

        img_ref = tf.image.decode_bmp(img_ref, channels=3)
        img_dist = tf.image.decode_bmp(img_dist, channels=3)

        img_ref = tf.image.convert_image_dtype(img_ref, dtype=tf.float32)
        img_dist = tf.image.convert_image_dtype(img_dist, dtype=tf.float32)

        return img_ref, img_dist, mos

    def load_data(self,
                  path,
                  exclude_imgs,
                  exclude_dist,
                  exclude_ints,
                  ):
        data = pd.read_csv(self.path_csv, index_col=0)
        data = data[~data.Reference_ID.isin(exclude_imgs)] if exclude_imgs is not None else data
        data = data[~data.Reference_ID.isin(exclude_dist)] if exclude_dist is not None else data
        data = data[~data.Reference_ID.isin(exclude_ints)] if exclude_ints is not None else data
        return data

